<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•æ›´æ–°åçš„ LeanCloud ç‰ˆæœ¬</title>
    <!-- LeanCloud SDK with LiveQuery support -->
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.15.2/dist/av-live-query-min.js"></script>
    <style>
        body { 
            font-family: sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            line-height: 1.6; 
        }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border-left: 4px solid; 
        }
        .success { background: #d4edda; border-color: #28a745; color: #155724; }
        .error { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .info { background: #d1ecf1; border-color: #17a2b8; color: #0c5460; }
        .warning { background: #fff3cd; border-color: #ffc107; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px 4px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>ğŸ¯ æµ‹è¯•æ›´æ–°åçš„ LeanCloud ç‰ˆæœ¬</h1>
    
    <div class="status info">
        <strong>ğŸ“‹ æµ‹è¯•ç›®æ ‡</strong><br>
        éªŒè¯ä½¿ç”¨ <code>ReadingAnnotation</code> Class çš„å®Œæ•´åº”ç”¨æ˜¯å¦æ­£å¸¸å·¥ä½œ<br>
        åŒ…æ‹¬ï¼šè½®è¯¢åŒæ­¥ã€è¯­éŸ³å½•åˆ¶ã€æ ‡æ³¨åŠŸèƒ½ç­‰
    </div>
    
    <button onclick="testConnection()">ğŸš€ æµ‹è¯• LeanCloud è¿æ¥</button>
    <button onclick="testReadingAnnotationClass()">ğŸ“ æµ‹è¯• ReadingAnnotation Class</button>
    <button onclick="openMainApp()">ğŸŒ¸ æ‰“å¼€ä¸»åº”ç”¨</button>
    <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
    
    <div id="logs"></div>

    <script>
        const CONFIG = {
            appId: 'Q9m29iJ6xOVxOtDqmKamdsFX-gzGzoHsz',
            appKey: 'pK6oNXPcsmpyXarHT91xMtW8',
            serverURL: 'https://q9m29ij6.lc-cn-n1-shared.com'
        };

        let currentUser = null;

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> ${message}`;
            logs.appendChild(div);
            console.log(message);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testConnection() {
            log('ğŸš€ å¼€å§‹æµ‹è¯• LeanCloud è¿æ¥...', 'info');
            
            try {
                if (typeof AV === 'undefined') {
                    throw new Error('LeanCloud SDK æœªåŠ è½½');
                }
                log('âœ… LeanCloud SDK å·²åŠ è½½', 'success');

                // åˆå§‹åŒ–
                AV.init({
                    appId: CONFIG.appId,
                    appKey: CONFIG.appKey,
                    serverURL: CONFIG.serverURL
                });
                log('âœ… LeanCloud åº”ç”¨åˆå§‹åŒ–å®Œæˆ', 'success');

                // åŒ¿åç™»å½•
                currentUser = await AV.User.loginAnonymously();
                log(`âœ… åŒ¿åç™»å½•æˆåŠŸï¼Œç”¨æˆ·ID: ${currentUser.id.substring(0, 8)}...`, 'success');

                log('<strong>ğŸ‰ LeanCloud è¿æ¥æµ‹è¯•æˆåŠŸï¼</strong>', 'success');
                
            } catch (error) {
                log(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testReadingAnnotationClass() {
            if (!currentUser) {
                log('âš ï¸ è¯·å…ˆæµ‹è¯•è¿æ¥', 'warning');
                return;
            }

            log('ğŸ“ å¼€å§‹æµ‹è¯• ReadingAnnotation Class...', 'info');
            
            try {
                // æµ‹è¯•æŸ¥è¯¢
                const query = new AV.Query('ReadingAnnotation');
                query.limit(5);
                const results = await query.find();
                log(`âœ… æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° ${results.length} æ¡è®°å½•`, 'success');

                // æµ‹è¯•åˆ›å»º
                const ReadingAnnotation = AV.Object.extend('ReadingAnnotation');
                const testObj = new ReadingAnnotation();
                
                testObj.set('chapterId', 'chapter-1');
                testObj.set('selectedText', 'æ›´æ–°ç‰ˆæœ¬æµ‹è¯•');
                testObj.set('range', { paragraphIndex: 0, startOffset: 0, endOffset: 8 });
                testObj.set('author', 'testUser');
                testObj.set('type', 'comment');
                testObj.set('content', `æµ‹è¯•æ›´æ–°ç‰ˆæœ¬ - ${new Date().toLocaleTimeString()}`);
                testObj.set('readBy', ['testUser']);

                const saved = await testObj.save();
                log(`âœ… åˆ›å»ºæˆåŠŸï¼æ–‡æ¡£ID: ${saved.id}`, 'success');

                // æµ‹è¯•æ›´æ–°
                saved.set('content', saved.get('content') + ' [å·²æ›´æ–°]');
                await saved.save();
                log('âœ… æ›´æ–°æˆåŠŸï¼', 'success');

                // æµ‹è¯•è½®è¯¢æŸ¥è¯¢ï¼ˆæ£€æŸ¥æ›´æ–°æ—¶é—´ï¼‰
                const pollQuery = new AV.Query('ReadingAnnotation');
                pollQuery.greaterThan('updatedAt', new Date(Date.now() - 10000)); // 10ç§’å†…çš„æ›´æ–°
                const recentUpdates = await pollQuery.find();
                log(`âœ… è½®è¯¢æŸ¥è¯¢æˆåŠŸï¼Œæ‰¾åˆ° ${recentUpdates.length} æ¡æœ€è¿‘æ›´æ–°`, 'success');

                // æ¸…ç†æµ‹è¯•æ•°æ®
                await saved.destroy();
                log('âœ… æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ', 'success');

                log('<strong>ğŸ‰ ReadingAnnotation Class æµ‹è¯•å®Œæˆï¼æ‰€æœ‰åŠŸèƒ½æ­£å¸¸</strong>', 'success');
                log('ğŸ’¡ ç°åœ¨å¯ä»¥ä½¿ç”¨ä¸»åº”ç”¨è¿›è¡Œå®Œæ•´æµ‹è¯•', 'info');
                
            } catch (error) {
                log(`âŒ ReadingAnnotation Class æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function openMainApp() {
            log('ğŸŒ¸ æ‰“å¼€ä¸»åº”ç”¨...', 'info');
            window.open('./leancloud-version.html', '_blank');
        }

        window.onload = () => {
            log('ğŸ¯ LeanCloud æ›´æ–°ç‰ˆæœ¬æµ‹è¯•å·¥å…·å·²å¯åŠ¨', 'info');
            log('ğŸ“ è¯·æŒ‰é¡ºåºè¿›è¡Œæµ‹è¯•: è¿æ¥ â†’ ReadingAnnotation Class â†’ ä¸»åº”ç”¨', 'info');
        };
    </script>
</body>
</html>