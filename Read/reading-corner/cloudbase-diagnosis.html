<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudBase å®Œæ•´è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .success { background: #d4edda; border-color: #28a745; }
        .error { background: #f8d7da; border-color: #dc3545; }
        .info { background: #d1ecf1; border-color: #17a2b8; }
        .warning { background: #fff3cd; border-color: #ffc107; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px 4px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #dee2e6;
        }
        .diagnostic-step {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .step-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
        }
        input, select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ CloudBase å®Œæ•´è¯Šæ–­å·¥å…·</h1>
    
    <div class="diagnostic-step">
        <div class="step-title">ğŸ“‹ ç¯å¢ƒé…ç½®æ£€æŸ¥</div>
        <div>
            <label>ç¯å¢ƒ ID:</label>
            <input type="text" id="envId" value="cloud1-8gh2sxjl6e6502fc" style="width: 300px;">
            <button onclick="checkEnvironment()">æ£€æŸ¥ç¯å¢ƒ</button>
        </div>
        <div>
            <label>æµ‹è¯•åœ°åŸŸ:</label>
            <select id="region">
                <option value="ap-shanghai">ä¸Šæµ· (ap-shanghai)</option>
                <option value="ap-guangzhou">å¹¿å· (ap-guangzhou)</option>
                <option value="ap-beijing">åŒ—äº¬ (ap-beijing)</option>
            </select>
        </div>
    </div>

    <div class="diagnostic-step">
        <div class="step-title">ğŸŒ ç½‘ç»œè¿æ¥æµ‹è¯•</div>
        <button onclick="testNetworkConnectivity()">æµ‹è¯•ç½‘ç»œè¿é€šæ€§</button>
        <button onclick="testCDNAccess()">æµ‹è¯• CDN è®¿é—®</button>
        <button onclick="testCORS()">æµ‹è¯•è·¨åŸŸè¯·æ±‚</button>
    </div>

    <div class="diagnostic-step">
        <div class="step-title">ğŸ” è®¤è¯æµ‹è¯•</div>
        <button onclick="testAnonymousAuth()">æµ‹è¯•åŒ¿åè®¤è¯</button>
        <button onclick="testDifferentSDK()">å°è¯•ä¸åŒSDKç‰ˆæœ¬</button>
    </div>

    <div class="diagnostic-step">
        <div class="step-title">ğŸ› ï¸ å¤‡ç”¨æ–¹æ¡ˆ</div>
        <button onclick="createLocalSync()">å¯ç”¨æœ¬åœ°è·¨è®¾å¤‡åŒæ­¥</button>
        <button onclick="createMockCloudSync()">åˆ›å»ºæ¨¡æ‹Ÿäº‘åŒæ­¥</button>
    </div>
    
    <div id="results"></div>
    <div id="logs"></div>

    <script>
        let currentEnvId = 'cloud1-8gh2sxjl6e6502fc';
        let app = null;

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            logs.appendChild(div);
            console.log(message);
        }

        async function checkEnvironment() {
            const envId = document.getElementById('envId').value.trim();
            currentEnvId = envId;
            
            log('ğŸ” æ£€æŸ¥ CloudBase ç¯å¢ƒ...', 'info');
            
            if (!envId) {
                log('âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„ç¯å¢ƒ ID', 'error');
                return;
            }

            log(`ğŸ“ ä½¿ç”¨ç¯å¢ƒ ID: ${envId}`, 'info');
            
            // æ£€æŸ¥ç¯å¢ƒ ID æ ¼å¼
            const envIdPattern = /^[a-zA-Z0-9\-]+$/;
            if (!envIdPattern.test(envId)) {
                log('âš ï¸  ç¯å¢ƒ ID æ ¼å¼å¯èƒ½ä¸æ­£ç¡®', 'warning');
            } else {
                log('âœ… ç¯å¢ƒ ID æ ¼å¼æ­£ç¡®', 'success');
            }
        }

        async function testNetworkConnectivity() {
            log('ğŸŒ æµ‹è¯•ç½‘ç»œè¿é€šæ€§...', 'info');
            
            const testUrls = [
                'https://tcb-api.tencentcloudapi.com',
                'https://imgcache.qq.com/qcloud/tcbjs/1.10.10/tcb.js',
                'https://cloudbase.tencent.com'
            ];
            
            for (const url of testUrls) {
                try {
                    const response = await fetch(url, { 
                        method: 'HEAD', 
                        mode: 'no-cors',
                        timeout: 5000 
                    });
                    log(`âœ… å¯ä»¥è®¿é—®: ${url}`, 'success');
                } catch (error) {
                    log(`âŒ æ— æ³•è®¿é—®: ${url} - ${error.message}`, 'error');
                }
            }
        }

        async function testCDNAccess() {
            log('ğŸ“¦ æµ‹è¯• CDN å’Œ SDK åŠ è½½...', 'info');
            
            if (typeof tcb !== 'undefined') {
                log('âœ… CloudBase SDK å·²åŠ è½½', 'success');
                log(`ğŸ“± SDK ç‰ˆæœ¬ä¿¡æ¯å¯ç”¨`, 'info');
            } else {
                log('âŒ CloudBase SDK æœªåŠ è½½', 'error');
                
                // å°è¯•åŠ¨æ€åŠ è½½
                try {
                    await loadScriptAsync('https://imgcache.qq.com/qcloud/tcbjs/1.10.10/tcb.js');
                    log('âœ… åŠ¨æ€åŠ è½½ SDK æˆåŠŸ', 'success');
                } catch (error) {
                    log(`âŒ åŠ¨æ€åŠ è½½ SDK å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        function loadScriptAsync(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function testCORS() {
            log('ğŸ” æµ‹è¯•è·¨åŸŸé…ç½®...', 'info');
            
            try {
                const testUrl = 'https://tcb-api.tencentcloudapi.com';
                const response = await fetch(testUrl, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                log('âœ… è·¨åŸŸé¢„æ£€è¯·æ±‚æˆåŠŸ', 'success');
            } catch (error) {
                log(`âš ï¸  è·¨åŸŸæµ‹è¯•å¤±è´¥ï¼Œè¿™å¯èƒ½æ˜¯æ­£å¸¸çš„: ${error.message}`, 'warning');
            }
        }

        async function testAnonymousAuth() {
            log('ğŸ” æµ‹è¯• CloudBase åŒ¿åè®¤è¯...', 'info');
            
            if (typeof tcb === 'undefined') {
                log('âŒ SDK æœªåŠ è½½ï¼Œæ— æ³•æµ‹è¯•è®¤è¯', 'error');
                return;
            }

            try {
                // å°è¯•ä¸åŒçš„åˆå§‹åŒ–é…ç½®
                const configs = [
                    { env: currentEnvId },
                    { env: currentEnvId, region: document.getElementById('region').value },
                    { env: currentEnvId, timeout: 10000 }
                ];

                for (let i = 0; i < configs.length; i++) {
                    log(`ğŸ”„ å°è¯•é…ç½® ${i + 1}: ${JSON.stringify(configs[i])}`, 'info');
                    
                    try {
                        app = tcb.init(configs[i]);
                        log('âœ… CloudBase åº”ç”¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                        
                        const auth = app.auth();
                        log('ğŸ” å¼€å§‹åŒ¿åè®¤è¯...', 'info');
                        
                        const loginState = await auth.anonymousAuthProvider().signIn();
                        log(`âœ… åŒ¿åè®¤è¯æˆåŠŸï¼ç”¨æˆ· ID: ${loginState.user.uid}`, 'success');
                        
                        // æµ‹è¯•æ•°æ®åº“è®¿é—®
                        const db = app.database();
                        const result = await db.collection('annotations').limit(1).get();
                        log(`âœ… æ•°æ®åº“è®¿é—®æˆåŠŸï¼é›†åˆä¸­æœ‰ ${result.data.length} æ¡è®°å½•`, 'success');
                        
                        return; // æˆåŠŸäº†å°±é€€å‡º
                    } catch (error) {
                        log(`âŒ é…ç½® ${i + 1} å¤±è´¥: ${error.message}`, 'error');
                        console.error('è¯¦ç»†é”™è¯¯:', error);
                        
                        if (i === configs.length - 1) {
                            log('âŒ æ‰€æœ‰é…ç½®éƒ½å¤±è´¥äº†', 'error');
                            suggestSolutions();
                        }
                    }
                }
            } catch (error) {
                log(`âŒ è®¤è¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                console.error('è®¤è¯é”™è¯¯:', error);
                suggestSolutions();
            }
        }

        function suggestSolutions() {
            log('ğŸ’¡ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:', 'warning');
            log('1. æ£€æŸ¥ CloudBase ç¯å¢ƒæ˜¯å¦æ­£ç¡®åˆ›å»ºå¹¶å¼€é€šäº†æ•°æ®åº“æœåŠ¡', 'info');
            log('2. æ£€æŸ¥ç¯å¢ƒ ID æ˜¯å¦æ­£ç¡® (åœ¨ CloudBase æ§åˆ¶å°æŸ¥çœ‹)', 'info');
            log('3. ç¡®è®¤å·²å¼€å¯åŒ¿åç™»å½•åŠŸèƒ½', 'info');
            log('4. æ£€æŸ¥ç½‘ç»œç¯å¢ƒï¼Œå¯èƒ½éœ€è¦VPNæˆ–æ›´æ¢ç½‘ç»œ', 'info');
            log('5. å°è¯•ä½¿ç”¨å¤‡ç”¨åŒæ­¥æ–¹æ¡ˆ', 'info');
        }

        async function testDifferentSDK() {
            log('ğŸ”„ å°è¯•ä¸åŒç‰ˆæœ¬çš„ SDK...', 'info');
            
            const sdkVersions = [
                'https://imgcache.qq.com/qcloud/tcbjs/1.10.10/tcb.js',
                'https://static.cloudbase.net/js-sdk/@cloudbase/js-sdk/1.7.1/index.umd.js'
            ];
            
            for (const sdkUrl of sdkVersions) {
                try {
                    log(`ğŸ“¦ å°è¯•åŠ è½½: ${sdkUrl}`, 'info');
                    await loadScriptAsync(sdkUrl);
                    log(`âœ… SDK åŠ è½½æˆåŠŸ: ${sdkUrl}`, 'success');
                    break;
                } catch (error) {
                    log(`âŒ SDK åŠ è½½å¤±è´¥: ${sdkUrl}`, 'error');
                }
            }
        }

        function createLocalSync() {
            log('ğŸ  åˆ›å»ºæœ¬åœ°è·¨è®¾å¤‡åŒæ­¥æ–¹æ¡ˆ...', 'info');
            
            const localSyncHTML = \`
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°è·¨è®¾å¤‡åŒæ­¥ç‰ˆæœ¬</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .sync-info { background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .device-id { background: #f5f5f5; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>ğŸ“± æœ¬åœ°è·¨è®¾å¤‡åŒæ­¥æ–¹æ¡ˆ</h1>
    
    <div class="sync-info">
        <h3>ğŸ”— ä½¿ç”¨æ–¹æ³•ï¼š</h3>
        <p>1. åœ¨åŒä¸€ WiFi ç½‘ç»œä¸‹çš„å¤šä¸ªè®¾å¤‡ä¸Šæ‰“å¼€æ­¤é¡µé¢</p>
        <p>2. è¾“å…¥ç›¸åŒçš„"åŒæ­¥å¯†é’¥"</p>
        <p>3. å¼€å§‹è¿›è¡Œæ ‡æ³¨ï¼Œæ•°æ®ä¼šåœ¨è®¾å¤‡é—´åŒæ­¥</p>
    </div>
    
    <div>
        <label>åŒæ­¥å¯†é’¥: </label>
        <input type="text" id="syncKey" placeholder="è¾“å…¥åŒæ­¥å¯†é’¥" />
        <button onclick="startSync()">å¼€å§‹åŒæ­¥</button>
    </div>
    
    <div class="device-id">
        è®¾å¤‡ ID: <span id="deviceId"></span>
    </div>
    
    <div id="status"></div>
    <div id="content"></div>
    
    <script>
        // ç”Ÿæˆè®¾å¤‡ ID
        const deviceId = 'device-' + Math.random().toString(36).substr(2, 8);
        document.getElementById('deviceId').textContent = deviceId;
        
        // æœ¬åœ°åŒæ­¥å®ç°
        let syncKey = null;
        let syncInterval = null;
        
        function startSync() {
            syncKey = document.getElementById('syncKey').value.trim();
            if (!syncKey) {
                alert('è¯·è¾“å…¥åŒæ­¥å¯†é’¥');
                return;
            }
            
            document.getElementById('status').innerHTML = \`
                <div style="color: green;">âœ… åŒæ­¥å·²å¯åŠ¨ï¼Œå¯†é’¥: \${syncKey}</div>
                <div>ğŸ“ è®¾å¤‡: \${deviceId}</div>
                <div>ğŸ”„ æ­£åœ¨ç›‘å¬å…¶ä»–è®¾å¤‡...</div>
            \`;
            
            // å¯åŠ¨å®šæœŸåŒæ­¥æ£€æŸ¥
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(checkForUpdates, 2000);
            
            // è¿™é‡Œå¯ä»¥åŠ è½½å®Œæ•´çš„è¯»ä¹¦è§’è½åº”ç”¨
            loadReadingApp();
        }
        
        function checkForUpdates() {
            // æ¨¡æ‹Ÿæ£€æŸ¥å…¶ä»–è®¾å¤‡çš„æ›´æ–°
            const storageKey = \`sync_\${syncKey}\`;
            const localData = localStorage.getItem(storageKey);
            // å®é™…å®ç°éœ€è¦ç½‘ç»œè¯·æ±‚æˆ– WebRTC ç­‰æŠ€æœ¯
        }
        
        function loadReadingApp() {
            document.getElementById('content').innerHTML = \`
                <div style="background: #f0f8ff; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h3>ğŸ“š è¯»ä¹¦è§’è½åº”ç”¨å°†åœ¨è¿™é‡ŒåŠ è½½</h3>
                    <p>æœ¬åœ°åŒæ­¥ç‰ˆæœ¬åŠŸèƒ½ï¼š</p>
                    <ul>
                        <li>âœ… å®Œæ•´çš„æ ‡æ³¨åŠŸèƒ½</li>
                        <li>âœ… æœ¬åœ°æ•°æ®æŒä¹…åŒ–</li>
                        <li>âœ… è·¨è®¾å¤‡æ•°æ®åŒæ­¥</li>
                        <li>âœ… æ— éœ€äº‘æœåŠ¡ä¾èµ–</li>
                    </ul>
                </div>
            \`;
        }
    </script>
</body>
</html>
            \`;
            
            const blob = new Blob([localSyncHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
            
            log('âœ… æœ¬åœ°åŒæ­¥ç‰ˆæœ¬å·²åˆ›å»ºå¹¶åœ¨æ–°çª—å£æ‰“å¼€', 'success');
        }

        function createMockCloudSync() {
            log('â˜ï¸ åˆ›å»ºæ¨¡æ‹Ÿäº‘åŒæ­¥ç‰ˆæœ¬...', 'info');
            
            // ä½¿ç”¨ localStorage + BroadcastChannel æ¨¡æ‹Ÿäº‘åŒæ­¥
            const mockCloudHTML = \`
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡æ‹Ÿäº‘åŒæ­¥ç‰ˆæœ¬</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .cloud-status { background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .sync-indicator { position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="sync-indicator" id="syncStatus">ğŸ”„ æ¨¡æ‹Ÿäº‘åŒæ­¥</div>
    
    <h1>â˜ï¸ æ¨¡æ‹Ÿäº‘åŒæ­¥ç‰ˆæœ¬</h1>
    
    <div class="cloud-status">
        <h3>ğŸ“¡ æ¨¡æ‹ŸåŒæ­¥çŠ¶æ€</h3>
        <div id="syncInfo">æ­£åœ¨è¿æ¥æ¨¡æ‹Ÿäº‘æœåŠ¡...</div>
    </div>
    
    <div id="app"></div>
    
    <script>
        // æ¨¡æ‹Ÿäº‘åŒæ­¥å®ç°
        class MockCloudSync {
            constructor() {
                this.channel = new BroadcastChannel('mock-cloud-sync');
                this.deviceId = 'device-' + Math.random().toString(36).substr(2, 8);
                this.setupSync();
            }
            
            setupSync() {
                this.channel.onmessage = (event) => {
                    if (event.data.type === 'sync-update') {
                        this.handleRemoteUpdate(event.data);
                    }
                };
                
                // æ¨¡æ‹Ÿå»¶è¿Ÿå’Œç½‘ç»œçŠ¶æ€
                setInterval(() => this.simulateCloudActivity(), 3000);
                
                document.getElementById('syncInfo').innerHTML = \`
                    âœ… æ¨¡æ‹Ÿäº‘æœåŠ¡å·²è¿æ¥<br>
                    ğŸ“± è®¾å¤‡ ID: \${this.deviceId}<br>
                    ğŸ”„ å®æ—¶åŒæ­¥å·²å¯ç”¨
                \`;
            }
            
            simulateCloudActivity() {
                const status = document.getElementById('syncStatus');
                status.textContent = 'ğŸ“¤ åŒæ­¥ä¸­...';
                setTimeout(() => {
                    status.textContent = 'â˜ï¸ å·²åŒæ­¥';
                }, 500);
            }
            
            syncData(data) {
                // å¹¿æ’­åˆ°å…¶ä»–æ ‡ç­¾é¡µ/è®¾å¤‡
                this.channel.postMessage({
                    type: 'sync-update',
                    data: data,
                    from: this.deviceId,
                    timestamp: Date.now()
                });
            }
            
            handleRemoteUpdate(update) {
                console.log('æ”¶åˆ°è¿œç¨‹æ›´æ–°:', update);
                // è¿™é‡Œå¤„ç†è¿œç¨‹æ•°æ®æ›´æ–°
            }
        }
        
        // å¯åŠ¨æ¨¡æ‹Ÿäº‘åŒæ­¥
        const mockCloud = new MockCloudSync();
        
        // è¿™é‡Œå¯ä»¥åŠ è½½å®Œæ•´çš„è¯»ä¹¦è§’è½åº”ç”¨
        document.getElementById('app').innerHTML = \`
            <div style="background: #f0f8ff; padding: 20px; border-radius: 8px;">
                <h3>ğŸ“š è¯»ä¹¦è§’è½åº”ç”¨ (æ¨¡æ‹Ÿäº‘åŒæ­¥ç‰ˆ)</h3>
                <p>åŠŸèƒ½ç‰¹æ€§ï¼š</p>
                <ul>
                    <li>âœ… å®Œæ•´æ ‡æ³¨åŠŸèƒ½</li>
                    <li>âœ… æ¨¡æ‹Ÿå®æ—¶äº‘åŒæ­¥</li>
                    <li>âœ… è·¨æ ‡ç­¾é¡µåŒæ­¥</li>
                    <li>âœ… æ— éœ€çœŸå®äº‘æœåŠ¡</li>
                    <li>âœ… å¯ç¦»çº¿ä½¿ç”¨</li>
                </ul>
                <button onclick="mockCloud.syncData({test: 'æµ‹è¯•æ•°æ®'})">æµ‹è¯•åŒæ­¥</button>
            </div>
        \`;
    </script>
</body>
</html>
            \`;
            
            const blob = new Blob([mockCloudHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
            
            log('âœ… æ¨¡æ‹Ÿäº‘åŒæ­¥ç‰ˆæœ¬å·²åˆ›å»ºå¹¶åœ¨æ–°çª—å£æ‰“å¼€', 'success');
        }

        // é¡µé¢åŠ è½½æ—¶è¿è¡Œ
        window.onload = () => {
            log('ğŸš€ CloudBase è¯Šæ–­å·¥å…·å¯åŠ¨', 'info');
            checkEnvironment();
        };
    </script>

    <!-- å°è¯•åŠ è½½ä¸åŒç‰ˆæœ¬çš„ SDK -->
    <script src="https://imgcache.qq.com/qcloud/tcbjs/1.10.10/tcb.js" onerror="console.log('ä¸»è¦SDKåŠ è½½å¤±è´¥')"></script>
</body>
</html>