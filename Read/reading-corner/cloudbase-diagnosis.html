<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudBase 完整诊断工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .success { background: #d4edda; border-color: #28a745; }
        .error { background: #f8d7da; border-color: #dc3545; }
        .info { background: #d1ecf1; border-color: #17a2b8; }
        .warning { background: #fff3cd; border-color: #ffc107; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px 4px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #dee2e6;
        }
        .diagnostic-step {
            background: #f8f9fa;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .step-title {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
        }
        input, select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>🔧 CloudBase 完整诊断工具</h1>
    
    <div class="diagnostic-step">
        <div class="step-title">📋 环境配置检查</div>
        <div>
            <label>环境 ID:</label>
            <input type="text" id="envId" value="cloud1-8gh2sxjl6e6502fc" style="width: 300px;">
            <button onclick="checkEnvironment()">检查环境</button>
        </div>
        <div>
            <label>测试地域:</label>
            <select id="region">
                <option value="ap-shanghai">上海 (ap-shanghai)</option>
                <option value="ap-guangzhou">广州 (ap-guangzhou)</option>
                <option value="ap-beijing">北京 (ap-beijing)</option>
            </select>
        </div>
    </div>

    <div class="diagnostic-step">
        <div class="step-title">🌐 网络连接测试</div>
        <button onclick="testNetworkConnectivity()">测试网络连通性</button>
        <button onclick="testCDNAccess()">测试 CDN 访问</button>
        <button onclick="testCORS()">测试跨域请求</button>
    </div>

    <div class="diagnostic-step">
        <div class="step-title">🔐 认证测试</div>
        <button onclick="testAnonymousAuth()">测试匿名认证</button>
        <button onclick="testDifferentSDK()">尝试不同SDK版本</button>
    </div>

    <div class="diagnostic-step">
        <div class="step-title">🛠️ 备用方案</div>
        <button onclick="createLocalSync()">启用本地跨设备同步</button>
        <button onclick="createMockCloudSync()">创建模拟云同步</button>
    </div>
    
    <div id="results"></div>
    <div id="logs"></div>

    <script>
        let currentEnvId = 'cloud1-8gh2sxjl6e6502fc';
        let app = null;

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            logs.appendChild(div);
            console.log(message);
        }

        async function checkEnvironment() {
            const envId = document.getElementById('envId').value.trim();
            currentEnvId = envId;
            
            log('🔍 检查 CloudBase 环境...', 'info');
            
            if (!envId) {
                log('❌ 请输入有效的环境 ID', 'error');
                return;
            }

            log(`📝 使用环境 ID: ${envId}`, 'info');
            
            // 检查环境 ID 格式
            const envIdPattern = /^[a-zA-Z0-9\-]+$/;
            if (!envIdPattern.test(envId)) {
                log('⚠️  环境 ID 格式可能不正确', 'warning');
            } else {
                log('✅ 环境 ID 格式正确', 'success');
            }
        }

        async function testNetworkConnectivity() {
            log('🌐 测试网络连通性...', 'info');
            
            const testUrls = [
                'https://tcb-api.tencentcloudapi.com',
                'https://imgcache.qq.com/qcloud/tcbjs/1.10.10/tcb.js',
                'https://cloudbase.tencent.com'
            ];
            
            for (const url of testUrls) {
                try {
                    const response = await fetch(url, { 
                        method: 'HEAD', 
                        mode: 'no-cors',
                        timeout: 5000 
                    });
                    log(`✅ 可以访问: ${url}`, 'success');
                } catch (error) {
                    log(`❌ 无法访问: ${url} - ${error.message}`, 'error');
                }
            }
        }

        async function testCDNAccess() {
            log('📦 测试 CDN 和 SDK 加载...', 'info');
            
            if (typeof tcb !== 'undefined') {
                log('✅ CloudBase SDK 已加载', 'success');
                log(`📱 SDK 版本信息可用`, 'info');
            } else {
                log('❌ CloudBase SDK 未加载', 'error');
                
                // 尝试动态加载
                try {
                    await loadScriptAsync('https://imgcache.qq.com/qcloud/tcbjs/1.10.10/tcb.js');
                    log('✅ 动态加载 SDK 成功', 'success');
                } catch (error) {
                    log(`❌ 动态加载 SDK 失败: ${error.message}`, 'error');
                }
            }
        }

        function loadScriptAsync(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function testCORS() {
            log('🔐 测试跨域配置...', 'info');
            
            try {
                const testUrl = 'https://tcb-api.tencentcloudapi.com';
                const response = await fetch(testUrl, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                log('✅ 跨域预检请求成功', 'success');
            } catch (error) {
                log(`⚠️  跨域测试失败，这可能是正常的: ${error.message}`, 'warning');
            }
        }

        async function testAnonymousAuth() {
            log('🔐 测试 CloudBase 匿名认证...', 'info');
            
            if (typeof tcb === 'undefined') {
                log('❌ SDK 未加载，无法测试认证', 'error');
                return;
            }

            try {
                // 尝试不同的初始化配置
                const configs = [
                    { env: currentEnvId },
                    { env: currentEnvId, region: document.getElementById('region').value },
                    { env: currentEnvId, timeout: 10000 }
                ];

                for (let i = 0; i < configs.length; i++) {
                    log(`🔄 尝试配置 ${i + 1}: ${JSON.stringify(configs[i])}`, 'info');
                    
                    try {
                        app = tcb.init(configs[i]);
                        log('✅ CloudBase 应用初始化成功', 'success');
                        
                        const auth = app.auth();
                        log('🔐 开始匿名认证...', 'info');
                        
                        const loginState = await auth.anonymousAuthProvider().signIn();
                        log(`✅ 匿名认证成功！用户 ID: ${loginState.user.uid}`, 'success');
                        
                        // 测试数据库访问
                        const db = app.database();
                        const result = await db.collection('annotations').limit(1).get();
                        log(`✅ 数据库访问成功！集合中有 ${result.data.length} 条记录`, 'success');
                        
                        return; // 成功了就退出
                    } catch (error) {
                        log(`❌ 配置 ${i + 1} 失败: ${error.message}`, 'error');
                        console.error('详细错误:', error);
                        
                        if (i === configs.length - 1) {
                            log('❌ 所有配置都失败了', 'error');
                            suggestSolutions();
                        }
                    }
                }
            } catch (error) {
                log(`❌ 认证测试失败: ${error.message}`, 'error');
                console.error('认证错误:', error);
                suggestSolutions();
            }
        }

        function suggestSolutions() {
            log('💡 可能的解决方案:', 'warning');
            log('1. 检查 CloudBase 环境是否正确创建并开通了数据库服务', 'info');
            log('2. 检查环境 ID 是否正确 (在 CloudBase 控制台查看)', 'info');
            log('3. 确认已开启匿名登录功能', 'info');
            log('4. 检查网络环境，可能需要VPN或更换网络', 'info');
            log('5. 尝试使用备用同步方案', 'info');
        }

        async function testDifferentSDK() {
            log('🔄 尝试不同版本的 SDK...', 'info');
            
            const sdkVersions = [
                'https://imgcache.qq.com/qcloud/tcbjs/1.10.10/tcb.js',
                'https://static.cloudbase.net/js-sdk/@cloudbase/js-sdk/1.7.1/index.umd.js'
            ];
            
            for (const sdkUrl of sdkVersions) {
                try {
                    log(`📦 尝试加载: ${sdkUrl}`, 'info');
                    await loadScriptAsync(sdkUrl);
                    log(`✅ SDK 加载成功: ${sdkUrl}`, 'success');
                    break;
                } catch (error) {
                    log(`❌ SDK 加载失败: ${sdkUrl}`, 'error');
                }
            }
        }

        function createLocalSync() {
            log('🏠 创建本地跨设备同步方案...', 'info');
            
            const localSyncHTML = \`
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本地跨设备同步版本</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .sync-info { background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .device-id { background: #f5f5f5; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>📱 本地跨设备同步方案</h1>
    
    <div class="sync-info">
        <h3>🔗 使用方法：</h3>
        <p>1. 在同一 WiFi 网络下的多个设备上打开此页面</p>
        <p>2. 输入相同的"同步密钥"</p>
        <p>3. 开始进行标注，数据会在设备间同步</p>
    </div>
    
    <div>
        <label>同步密钥: </label>
        <input type="text" id="syncKey" placeholder="输入同步密钥" />
        <button onclick="startSync()">开始同步</button>
    </div>
    
    <div class="device-id">
        设备 ID: <span id="deviceId"></span>
    </div>
    
    <div id="status"></div>
    <div id="content"></div>
    
    <script>
        // 生成设备 ID
        const deviceId = 'device-' + Math.random().toString(36).substr(2, 8);
        document.getElementById('deviceId').textContent = deviceId;
        
        // 本地同步实现
        let syncKey = null;
        let syncInterval = null;
        
        function startSync() {
            syncKey = document.getElementById('syncKey').value.trim();
            if (!syncKey) {
                alert('请输入同步密钥');
                return;
            }
            
            document.getElementById('status').innerHTML = \`
                <div style="color: green;">✅ 同步已启动，密钥: \${syncKey}</div>
                <div>📍 设备: \${deviceId}</div>
                <div>🔄 正在监听其他设备...</div>
            \`;
            
            // 启动定期同步检查
            if (syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(checkForUpdates, 2000);
            
            // 这里可以加载完整的读书角落应用
            loadReadingApp();
        }
        
        function checkForUpdates() {
            // 模拟检查其他设备的更新
            const storageKey = \`sync_\${syncKey}\`;
            const localData = localStorage.getItem(storageKey);
            // 实际实现需要网络请求或 WebRTC 等技术
        }
        
        function loadReadingApp() {
            document.getElementById('content').innerHTML = \`
                <div style="background: #f0f8ff; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h3>📚 读书角落应用将在这里加载</h3>
                    <p>本地同步版本功能：</p>
                    <ul>
                        <li>✅ 完整的标注功能</li>
                        <li>✅ 本地数据持久化</li>
                        <li>✅ 跨设备数据同步</li>
                        <li>✅ 无需云服务依赖</li>
                    </ul>
                </div>
            \`;
        }
    </script>
</body>
</html>
            \`;
            
            const blob = new Blob([localSyncHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
            
            log('✅ 本地同步版本已创建并在新窗口打开', 'success');
        }

        function createMockCloudSync() {
            log('☁️ 创建模拟云同步版本...', 'info');
            
            // 使用 localStorage + BroadcastChannel 模拟云同步
            const mockCloudHTML = \`
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模拟云同步版本</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .cloud-status { background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .sync-indicator { position: fixed; top: 20px; right: 20px; background: #4CAF50; color: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="sync-indicator" id="syncStatus">🔄 模拟云同步</div>
    
    <h1>☁️ 模拟云同步版本</h1>
    
    <div class="cloud-status">
        <h3>📡 模拟同步状态</h3>
        <div id="syncInfo">正在连接模拟云服务...</div>
    </div>
    
    <div id="app"></div>
    
    <script>
        // 模拟云同步实现
        class MockCloudSync {
            constructor() {
                this.channel = new BroadcastChannel('mock-cloud-sync');
                this.deviceId = 'device-' + Math.random().toString(36).substr(2, 8);
                this.setupSync();
            }
            
            setupSync() {
                this.channel.onmessage = (event) => {
                    if (event.data.type === 'sync-update') {
                        this.handleRemoteUpdate(event.data);
                    }
                };
                
                // 模拟延迟和网络状态
                setInterval(() => this.simulateCloudActivity(), 3000);
                
                document.getElementById('syncInfo').innerHTML = \`
                    ✅ 模拟云服务已连接<br>
                    📱 设备 ID: \${this.deviceId}<br>
                    🔄 实时同步已启用
                \`;
            }
            
            simulateCloudActivity() {
                const status = document.getElementById('syncStatus');
                status.textContent = '📤 同步中...';
                setTimeout(() => {
                    status.textContent = '☁️ 已同步';
                }, 500);
            }
            
            syncData(data) {
                // 广播到其他标签页/设备
                this.channel.postMessage({
                    type: 'sync-update',
                    data: data,
                    from: this.deviceId,
                    timestamp: Date.now()
                });
            }
            
            handleRemoteUpdate(update) {
                console.log('收到远程更新:', update);
                // 这里处理远程数据更新
            }
        }
        
        // 启动模拟云同步
        const mockCloud = new MockCloudSync();
        
        // 这里可以加载完整的读书角落应用
        document.getElementById('app').innerHTML = \`
            <div style="background: #f0f8ff; padding: 20px; border-radius: 8px;">
                <h3>📚 读书角落应用 (模拟云同步版)</h3>
                <p>功能特性：</p>
                <ul>
                    <li>✅ 完整标注功能</li>
                    <li>✅ 模拟实时云同步</li>
                    <li>✅ 跨标签页同步</li>
                    <li>✅ 无需真实云服务</li>
                    <li>✅ 可离线使用</li>
                </ul>
                <button onclick="mockCloud.syncData({test: '测试数据'})">测试同步</button>
            </div>
        \`;
    </script>
</body>
</html>
            \`;
            
            const blob = new Blob([mockCloudHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
            
            log('✅ 模拟云同步版本已创建并在新窗口打开', 'success');
        }

        // 页面加载时运行
        window.onload = () => {
            log('🚀 CloudBase 诊断工具启动', 'info');
            checkEnvironment();
        };
    </script>

    <!-- 尝试加载不同版本的 SDK -->
    <script src="https://imgcache.qq.com/qcloud/tcbjs/1.10.10/tcb.js" onerror="console.log('主要SDK加载失败')"></script>
</body>
</html>